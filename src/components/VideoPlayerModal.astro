---
import { toHref } from '../config';
const hlsSrc = toHref('/videos/spot-dental-gran-avenida/master.m3u8');
---

<video-player-modal data-hls-src={hlsSrc}>
	<div
		class="fixed inset-0 z-50 hidden items-center justify-center bg-black/90 p-4"
		role="dialog"
		aria-modal="true"
		aria-labelledby="video-modal-title"
		aria-hidden="true"
	>
		<h2 id="video-modal-title" class="sr-only">Reproductor de video</h2>
		<div class="relative w-full max-w-4xl">
			<button
				type="button"
				class="video-modal-close absolute -top-12 right-0 z-10 flex size-10 items-center justify-center rounded-full bg-white/10 text-white transition-colors hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-transparent"
				aria-label="Cerrar reproductor"
			>
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="size-6" fill="currentColor" aria-hidden="true">
					<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
				</svg>
			</button>
			<div class="video-player-container aspect-video w-full overflow-hidden rounded-lg bg-black" />
		</div>
	</div>
</video-player-modal>

<style is:global>
	/* VideoJS base — imported via Vite from local npm package */

	.vjs-dental-gran-avenida.video-js {
		color: var(--color-blue-white);
	}

	.vjs-dental-gran-avenida .vjs-big-play-button {
		width: 4rem;
		height: 4rem;
		border-radius: 9999px;
		border: 2px solid rgba(255, 255, 255, 0.4);
		background-color: rgba(255, 255, 255, 0.15);
		backdrop-filter: blur(4px);
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		margin: 0;
		transition: transform 0.3s ease, background-color 0.3s ease;
	}

	.vjs-dental-gran-avenida:hover .vjs-big-play-button,
	.vjs-dental-gran-avenida .vjs-big-play-button:hover,
	.vjs-dental-gran-avenida .vjs-big-play-button:focus {
		background-color: var(--color-french-ultramarine);
		border-color: var(--color-french-ultramarine);
		transform: translate(-50%, -50%) scale(1.1);
	}

	.vjs-dental-gran-avenida .vjs-big-play-button .vjs-icon-placeholder::before {
		font-size: 2rem;
		line-height: 4rem;
	}

	.vjs-dental-gran-avenida .vjs-volume-level,
	.vjs-dental-gran-avenida .vjs-play-progress,
	.vjs-dental-gran-avenida .vjs-slider-bar {
		background-color: var(--color-bright-ocean);
	}

	.vjs-dental-gran-avenida .vjs-control-bar {
		background: linear-gradient(
			to top,
			color-mix(in srgb, var(--color-navy-blue) 90%, transparent),
			color-mix(in srgb, var(--color-navy-blue) 70%, transparent)
		);
	}

	.vjs-dental-gran-avenida .vjs-play-progress .vjs-svg-icon {
		top: 50%;
		right: -0.4em;
		transform: translateY(-50%);
	}

	.vjs-dental-gran-avenida .vjs-slider:focus .vjs-slider-handle {
		text-shadow: 0 0 1em var(--color-blue-white);
		box-shadow: 0 0 1em var(--color-bright-ocean);
	}

	.vjs-dental-gran-avenida .vjs-button:hover,
	.vjs-dental-gran-avenida .vjs-button:focus {
		color: var(--color-bright-ocean);
	}

	.vjs-dental-gran-avenida .vjs-load-progress {
		background-color: color-mix(in srgb, var(--color-blue-white) 30%, transparent);
	}
</style>

<script>
	import 'video.js/dist/video-js.css';
	import videojs from 'video.js';

	const FOCUSABLE = [
		'a[href]',
		'button:not([disabled])',
		'input:not([disabled])',
		'select:not([disabled])',
		'textarea:not([disabled])',
		'[tabindex]:not([tabindex="-1"])',
	].join(', ');

	class VideoPlayerModal extends HTMLElement {
		connectedCallback() {
			const hlsSrc = this.dataset.hlsSrc!;
			const modal = this.querySelector<HTMLElement>('[role="dialog"]');
			const container = this.querySelector('.video-player-container');
			const closeBtn = this.querySelector<HTMLElement>('.video-modal-close');

			let player: ReturnType<typeof videojs> | null = null;
			let lastFocusedTrigger: HTMLElement | null = null;

			/* ── Focus trap ─────────────────────────────────────── */

			const trapFocus = (e: KeyboardEvent) => {
				if (!modal || e.key !== 'Tab') return;
				const focusable = Array.from(modal.querySelectorAll<HTMLElement>(FOCUSABLE));
				if (focusable.length === 0) return;

				const first = focusable[0];
				const last = focusable[focusable.length - 1];

				if (e.shiftKey) {
					if (document.activeElement === first) {
						e.preventDefault();
						last.focus();
					}
				} else {
					if (document.activeElement === last) {
						e.preventDefault();
						first.focus();
					}
				}
			};

			/* ── Open / close ───────────────────────────────────── */

			const openModal = (trigger?: HTMLElement) => {
				if (!modal || !container) return;
				lastFocusedTrigger = trigger ?? null;

				modal.classList.remove('hidden');
				modal.classList.add('flex');
				modal.setAttribute('aria-hidden', 'false');
				document.body.style.overflow = 'hidden';

				const videoEl = document.createElement('video');
				videoEl.className = 'video-js vjs-big-play-centered vjs-dental-gran-avenida';
				videoEl.controls = true;
				videoEl.preload = 'auto';
				videoEl.playsInline = true;
				videoEl.setAttribute('data-setup', '{}');
				container.appendChild(videoEl);

				player = videojs(videoEl, {
					fluid: true,
					html5: {
						vhs: { enableLowInitialPlaylist: true, fastStart: true },
					},
					sources: [{ src: hlsSrc, type: 'application/x-mpegURL' }],
				});
				player.play();
				closeBtn?.focus();
				document.addEventListener('keydown', trapFocus);
			};

			const closeModal = () => {
				if (!modal) return;
				document.removeEventListener('keydown', trapFocus);
				modal.classList.add('hidden');
				modal.classList.remove('flex');
				modal.setAttribute('aria-hidden', 'true');
				document.body.style.overflow = '';
				if (player && !player.isDisposed()) {
					player.dispose();
					player = null;
				}
				lastFocusedTrigger?.focus();
				lastFocusedTrigger = null;
			};

			/* ── Triggers ───────────────────────────────────────── */

			document.querySelectorAll<HTMLElement>('.video-overlay-wrapper, [aria-label*="Reproducir video"]').forEach((trigger) => {
				trigger.addEventListener('click', () => openModal(trigger));
				trigger.addEventListener('keydown', (e) => {
					if (e.key === 'Enter' || e.key === ' ') {
						e.preventDefault();
						openModal(trigger);
					}
				});
			});

			closeBtn?.addEventListener('click', closeModal);
			modal?.addEventListener('click', (e) => {
				if (e.target === modal) closeModal();
			});
			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape' && modal?.classList.contains('flex')) closeModal();
			});
		}
	}

	customElements.define('video-player-modal', VideoPlayerModal);
</script>
