---
import { Image } from "astro:assets";
import { config, toHref } from "../config";
import Button from "./Button.astro";
import UrgencyButton from "./UrgencyButton.astro";
import logo from "../assets/images/logo-transparent.png";
import { specialties } from "../data/specialties";

type NavLink =
  | { href: string; label: string; hasDropdown: false }
  | { label: string; hasDropdown: true };

const navLinks: NavLink[] = [
  { href: "/", label: "Inicio", hasDropdown: false },
  { label: "Especialidades", hasDropdown: true },
  {
    href: "/conoce-la-clinica",
    label: "Conoce la Clínica",
    hasDropdown: false,
  },
  { href: "/contacto", label: "Contacto", hasDropdown: false },
];

const pathname = Astro.url.pathname.replace(/\/$/, "") || "/";
const isActive = (href: string) => {
  const full = toHref(href);
  if (href === "/") return pathname === full;
  return pathname === full || pathname.startsWith(full + "/");
};
const isSpecialtiesActive = pathname.startsWith(toHref('/especialidades'));
---

<header
  id="main-header"
  class="bg-blue-white py-5 w-full relative z-50 overflow-visible"
>
  <div
    class="container-site flex items-center justify-between overflow-visible"
  >
    <div class="flex gap-8 lg:gap-20 items-center">
      <a
        href={toHref('/')}
        class="h-14 w-32 shrink-0 block focus-ring rounded-lg"
        aria-label="Dental Gran Avenida - Inicio"
      >
        <Image
          src={logo}
          alt="Dental Gran Avenida"
          class="h-full w-auto object-contain object-left"
          loading="eager"
        />
      </a>

      <nav
        class="hidden md:flex gap-6 lg:gap-10 items-center"
        aria-label="Navegación principal"
      >
        {
          navLinks.map((link) =>
            link.hasDropdown ? (
              <div class="relative group" id="nav-specialties">
                <button
                  type="button"
                  class:list={[
                    "flex gap-1.5 items-center text-base transition-colors whitespace-nowrap py-2 bg-transparent border-none cursor-pointer font-inherit",
                    isSpecialtiesActive
                      ? "text-french-ultramarine underline decoration-dashed decoration-french-ultramarine/30 underline-offset-8"
                      : "text-black font-normal hover:text-french-ultramarine",
                  ]}
                  aria-haspopup="true"
                  aria-expanded="false"
                  aria-label="Especialidades, desplegar menú"
                >
                  {link.label}
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 9 5"
                    class="w-[9px] h-[5px] shrink-0 fill-current transition-transform group-hover:rotate-180"
                    aria-hidden="true"
                  >
                    <path
                      d="M0.5 0.5L4.5 4.5L8.5 0.5"
                      stroke="currentColor"
                      stroke-width="1.2"
                      fill="none"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </button>
                <div
                  class="absolute left-0 top-full pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-[opacity,visibility] duration-200"
                  role="menu"
                  aria-label="Especialidades"
                >
                  <ul class="bg-white rounded-xl shadow-lg border border-navy-blue/10 py-2 min-w-72">
                    {specialties.map((s) => (
                      <li role="none">
                        <a
                          href={toHref(`/especialidades/${s.slug}`)}
                          class:list={[
                            "flex items-center gap-2 px-4 py-2.5 text-base transition-colors",
                            pathname === toHref(`/especialidades/${s.slug}`)
                              ? "text-french-ultramarine bg-blue-white"
                              : "text-body hover:bg-blue-white hover:text-french-ultramarine",
                          ]}
                          role="menuitem"
                          aria-label={`Ir a ${s.label}`}
                        >
                          {s.label}
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            ) : (
              <a
                href={toHref(link.href)}
                class:list={[
                  "flex gap-1.5 items-center text-base transition-colors whitespace-nowrap focus-ring rounded",
                  isActive(link.href)
                    ? "text-french-ultramarine underline decoration-dashed decoration-french-ultramarine/30 underline-offset-8"
                    : "text-black font-normal hover:text-french-ultramarine",
                ]}
                aria-current={isActive(link.href) ? "page" : undefined}
              >
                {link.label}
              </a>
            ),
          )
        }
      </nav>
    </div>

    <div class="hidden md:flex gap-3 items-center">
      <UrgencyButton href={`tel:+${config.whatsapp.phone}`} expandable />
      <Button
        href={config.whatsapp.url}
        label="Agendar hora"
        variant="primary"
        target="_blank"
      />
    </div>

    <button
      type="button"
      id="menu-toggle"
      class="md:hidden flex flex-col items-center justify-center gap-1.5 size-12 min-w-12 -mr-2 rounded-lg hover:bg-navy-blue/5 transition-colors touch-manipulation overflow-visible focus-ring [&.is-open_span:nth-child(1)]:rotate-45 [&.is-open_span:nth-child(1)]:translate-y-2 [&.is-open_span:nth-child(2)]:opacity-0 [&.is-open_span:nth-child(3)]:-rotate-45 [&.is-open_span:nth-child(3)]:-translate-y-2"
      aria-label="Abrir menú"
      aria-expanded="false"
      aria-controls="mobile-menu"
    >
      <span
        class="block w-5 h-0.5 bg-navy-blue rounded-full transition-transform duration-300 origin-center"
        aria-hidden="true"></span>
      <span
        class="block w-5 h-0.5 bg-navy-blue rounded-full transition-all duration-300 origin-center"
        aria-hidden="true"></span>
      <span
        class="block w-5 h-0.5 bg-navy-blue rounded-full transition-transform duration-300 origin-center"
        aria-hidden="true"></span>
    </button>
  </div>
</header>

<div
  id="mobile-sticky-header"
  class="md:hidden fixed top-0 left-0 right-0 z-40 bg-blue-white py-3 shadow-md transition-transform duration-300 -translate-y-full"
  aria-hidden="true"
>
  <div class="container-site flex items-center justify-between gap-2">
    <a
      href={toHref('/')}
      class="h-10 w-24 shrink-0 block focus-ring rounded-lg"
      aria-label="Dental Gran Avenida - Inicio"
    >
      <Image
        src={logo}
        alt=""
        class="h-full w-auto object-contain object-left"
        loading="eager"
      />
    </a>
    <div class="flex gap-2 items-center shrink-0">
      <UrgencyButton href={`tel:+${config.whatsapp.phone}`} compact />
    </div>
  </div>
</div>

<div
  id="mobile-menu"
  class="fixed inset-0 z-40 md:hidden bg-blue-white invisible opacity-0 pointer-events-none transition-[visibility,opacity] duration-300 ease-out [&.is-open]:visible [&.is-open]:opacity-100 [&.is-open]:pointer-events-auto overflow-x-hidden overscroll-contain"
  aria-hidden="true"
>
  <div
    class="flex flex-col h-full overflow-hidden min-w-0 pt-24 w-full max-w-full overscroll-contain"
  >
    <div class="container-site shrink-0 flex gap-3 w-full pt-6 pb-2">
      <UrgencyButton
        href={`tel:+${config.whatsapp.phone}`}
        class="flex-1 min-w-0 touch-manipulation justify-center"
      />
      <Button
        href={config.whatsapp.url}
        label="Agendar hora"
        variant="primary"
        target="_blank"
        class="flex-1 min-w-0 touch-manipulation"
      />
    </div>

    <nav
      class="flex-1 flex flex-col justify-center container-site py-8 min-w-0 w-full"
      aria-label="Navegación móvil"
    >
      <ul class="flex flex-col w-full min-w-0">
        {
          navLinks.map((link) =>
            link.hasDropdown ? (
              <li class="border-b border-navy-blue/10">
                <button
                  type="button"
                  id="mobile-specialties-toggle"
                  class="flex w-full items-center justify-between py-4 text-lg text-left transition-colors focus-ring rounded"
                  aria-expanded="false"
                  aria-controls="mobile-specialties-list"
                  aria-label="Especialidades, expandir menú"
                >
                  <span
                    class:list={[
                      isSpecialtiesActive
                        ? "text-french-ultramarine"
                        : "text-black font-normal",
                    ]}
                  >
                    {link.label}
                  </span>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 9 5"
                    class="w-[9px] h-[5px] shrink-0 fill-current transition-transform duration-200"
                    aria-hidden="true"
                  >
                    <path
                      d="M0.5 0.5L4.5 4.5L8.5 0.5"
                      stroke="currentColor"
                      stroke-width="1.2"
                      fill="none"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </button>
                <ul
                  id="mobile-specialties-list"
                  class="hidden flex-col pb-2"
                  aria-hidden="true"
                  aria-label="Lista de especialidades"
                >
                  {specialties.map((s) => (
                    <li>
                      <a
                        href={toHref(`/especialidades/${s.slug}`)}
                        class:list={[
                          "flex items-center gap-2 py-3 pl-4 text-base transition-colors border-l-2 -ml-px focus-ring rounded-r",
                          pathname === toHref(`/especialidades/${s.slug}`)
                            ? "text-french-ultramarine border-french-ultramarine"
                            : "text-body border-transparent hover:text-french-ultramarine hover:border-french-ultramarine",
                        ]}
                        aria-current={
                          pathname === toHref(`/especialidades/${s.slug}`)
                            ? "page"
                            : undefined
                        }
                        aria-label={`Ir a ${s.label}`}
                      >
                        {s.label}
                      </a>
                    </li>
                  ))}
                </ul>
              </li>
            ) : (
              <li>
                <a
                  href={toHref(link.href)}
                  class:list={[
                    "block py-4 text-lg transition-colors border-b border-navy-blue/10 focus-ring rounded",
                    isActive(link.href)
                      ? "text-french-ultramarine underline-dash"
                      : "text-black font-normal hover:text-french-ultramarine",
                  ]}
                  aria-current={isActive(link.href) ? "page" : undefined}
                >
                  {link.label}
                </a>
              </li>
            ),
          )
        }
      </ul>
    </nav>

    <div
      class="container-site shrink-0 flex gap-3 items-center justify-center py-6"
    >
      <a
        href={config.social.facebook}
        target="_blank"
        rel="noopener noreferrer"
        class="bg-dark-sea-blue flex items-center justify-center size-10 rounded-full p-2 shrink-0 hover:opacity-80 transition-opacity focus-ring-on-dark"
        aria-label="Facebook"
      >
        <svg
          width="8"
          height="16"
          viewBox="0 0 8 16"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          class="fill-blue-white"
          aria-hidden="true"
        >
          <path
            d="M4.75625 3.425C4.75625 2.78125 5.33125 2.55 5.975 2.55C6.61875 2.55 7.30625 2.75 7.30625 2.75L7.71875 0.299999C7.71875 0.299999 6.84375 0 4.75625 0C3.475 0 2.73125 0.487499 2.1875 1.20625C1.675 1.8875 1.65625 2.98125 1.65625 3.6875V5.29375H0V7.6875H1.65625V16H4.75625V7.6875H7.2125L7.39375 5.29375H4.75625V3.425Z"
          ></path>
        </svg>
      </a>
      <a
        href={config.social.instagram}
        target="_blank"
        rel="noopener noreferrer"
        class="bg-dark-sea-blue flex items-center justify-center size-10 rounded-full p-2 shrink-0 hover:opacity-80 transition-opacity focus-ring-on-dark"
        aria-label="Instagram"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 16 16"
          class="size-4 fill-blue-white"
          aria-hidden="true"
        >
          <path
            d="M8 1.441c2.136 0 2.389.008 3.232.047.78.035 1.204.166 1.486.275.373.145.64.318.92.598s.453.546.598.92c.11.282.24.705.275 1.486.038.843.047 1.096.047 3.232s-.009 2.389-.047 3.232c-.035.78-.166 1.204-.275 1.486a2.479 2.479 0 0 1-.598.92 2.479 2.479 0 0 1-.92.598c-.282.11-.705.24-1.486.275-.843.038-1.096.047-3.232.047s-2.389-.009-3.232-.047c-.78-.035-1.204-.166-1.486-.275a2.479 2.479 0 0 1-.92-.598 2.479 2.479 0 0 1-.598-.92c-.11-.282-.24-.705-.275-1.486C1.45 10.389 1.44 10.136 1.44 8s.008-2.389.047-3.232c.035-.78.166-1.204.275-1.486.145-.373.318-.64.598-.92s.546-.453.92-.598c.282-.11.705-.24 1.486-.275.843-.038 1.096-.047 3.232-.047ZM8 0C5.827 0 5.555.009 4.702.048 3.85.087 3.268.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.917 3.917 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.702.009 5.555 0 5.827 0 8c0 2.173.009 2.445.048 3.298.039.852.174 1.433.372 1.942.204.526.478.972.923 1.417.445.445.89.719 1.417.923.509.198 1.09.333 1.942.372C5.555 15.991 5.827 16 8 16c2.173 0 2.445-.009 3.298-.048.852-.039 1.433-.174 1.942-.372a3.916 3.916 0 0 0 1.417-.923 3.916 3.916 0 0 0 .923-1.417c.198-.509.333-1.09.372-1.942C15.991 10.445 16 10.173 16 8c0-2.173-.009-2.445-.048-3.298-.039-.852-.174-1.433-.372-1.942a3.916 3.916 0 0 0-.923-1.417A3.916 3.916 0 0 0 13.24.42C12.732.222 12.15.087 11.298.048 10.445.009 10.173 0 8 0Zm0 3.892a4.108 4.108 0 1 0 0 8.216 4.108 4.108 0 0 0 0-8.216ZM8 10.667A2.667 2.667 0 1 1 8 5.333a2.667 2.667 0 0 1 0 5.334ZM13.23 3.719a.96.96 0 1 1-1.92 0 .96.96 0 0 1 1.92 0Z"
          ></path>
        </svg>
      </a>
      <a
        href={config.whatsapp.url}
        target="_blank"
        rel="noopener noreferrer"
        class="bg-dark-sea-blue flex items-center justify-center size-10 rounded-full p-2 shrink-0 hover:opacity-80 transition-opacity focus-ring-on-dark"
        aria-label="WhatsApp"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 16 16"
          class="size-4 fill-blue-white"
          aria-hidden="true"
        >
          <path
            d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.628 0 .07 3.558.07 7.924c0 1.396.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.367 0 7.925-3.558 7.925-7.924a7.88 7.88 0 0 0-2.322-5.613ZM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592Zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232Z"
          ></path>
        </svg>
      </a>
    </div>

  </div>
</div>

<script is:inline>
  document.addEventListener("DOMContentLoaded", function () {
    const toggle = document.getElementById("menu-toggle");
    const menu = document.getElementById("mobile-menu");
    const mainHeader = document.getElementById("main-header");
    const stickyHeader = document.getElementById("mobile-sticky-header");

    if (mainHeader && stickyHeader) {
      let observer = null;
      const mediaQuery = window.matchMedia("(max-width: 767px)");

      function setupStickyHeader() {
        if (!mediaQuery.matches) {
          stickyHeader.classList.add("-translate-y-full");
          stickyHeader.classList.remove("translate-y-0");
          stickyHeader.setAttribute("aria-hidden", "true");
          if (observer) {
            observer.disconnect();
            observer = null;
          }
          return;
        }
        observer = new IntersectionObserver(
          ([entry]) => {
            const headerInView = entry.isIntersecting;
            stickyHeader.classList.toggle("-translate-y-full", headerInView);
            stickyHeader.classList.toggle("translate-y-0", !headerInView);
            stickyHeader.setAttribute("aria-hidden", String(headerInView));
          },
          { threshold: 0 },
        );
        observer.observe(mainHeader);
      }

      mediaQuery.addEventListener("change", setupStickyHeader);
      setupStickyHeader();
    }

    function openMenu() {
      menu?.classList.add("is-open");
      toggle?.classList.add("is-open");
      menu?.setAttribute("aria-hidden", "false");
      toggle?.setAttribute("aria-expanded", "true");
      toggle?.setAttribute("aria-label", "Cerrar menú");
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";
      document.body.style.touchAction = "none";
    }

    function closeMenu() {
      menu?.classList.remove("is-open");
      toggle?.classList.remove("is-open");
      menu?.setAttribute("aria-hidden", "true");
      toggle?.setAttribute("aria-expanded", "false");
      toggle?.setAttribute("aria-label", "Abrir menú");
      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
      document.body.style.touchAction = "";
    }

    toggle?.addEventListener("click", () => {
      if (menu?.classList.contains("is-open")) closeMenu();
      else openMenu();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && menu?.classList.contains("is-open"))
        closeMenu();
    });

    document.querySelectorAll("#mobile-menu a[href]").forEach((link) => {
      link.addEventListener("click", () => closeMenu());
    });

    const specialtiesToggle = document.getElementById(
      "mobile-specialties-toggle",
    );
    const specialtiesList = document.getElementById("mobile-specialties-list");
    if (specialtiesToggle && specialtiesList) {
      specialtiesToggle.addEventListener("click", () => {
        const isExpanded =
          specialtiesToggle.getAttribute("aria-expanded") === "true";
        specialtiesToggle.setAttribute("aria-expanded", String(!isExpanded));
        specialtiesList.classList.toggle("hidden", isExpanded);
        specialtiesList.classList.toggle("flex", !isExpanded);
        specialtiesList.setAttribute("aria-hidden", String(isExpanded));
        specialtiesToggle
          .querySelector("svg")
          ?.classList.toggle("rotate-180", !isExpanded);
      });
    }
  });
</script>
